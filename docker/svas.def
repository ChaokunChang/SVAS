Bootstrap: docker
From: nvidia/cuda:10.2-devel
Stage: spython-base

%post

# nvidia env
NVIDIA_VISIBLE_DEVICES=all
NVIDIA_DRIVER_CAPABILITIES=video,compute,utility

apt-get update
apt-get install -y software-properties-common
add-apt-repository ppa:jonathonf/ffmpeg-4
apt-get install -y build-essential make cmake
apt-get install -y ffmpeg libavcodec-dev libavfilter-dev libavformat-dev libavutil-dev
apt-get install -y git vim curl unzip python3-pip
add-apt-repository ppa:deadsnakes/ppa -y
apt-get install python3.8 python3.8-dev python3.8-distutils python3-pip -y
python3.8 -m pip install --upgrade pip setuptools wheel
yes | pip --no-cache-dir install torch numpy Pillow tqdm lmdb torchvision blist scipy flask
rm /usr/bin/python3 && ln -s /usr/bin/python3.8 /usr/bin/python3

# nvcodec
curl -fsSL https://developer.download.nvidia.com/compute/redist/VideoCodec/v8.2/NvCodec.zip -O && \
unzip -j NvCodec.zip \
NvCodec/Lib/linux/stubs/x86_64/libnvcuvid.so \
NvCodec/Lib/linux/stubs/x86_64/libnvidia-encode.so \
-d /usr/local/cuda/lib64/stubs && \
rm NvCodec.zip && \
rm -rf NvCodec && \
ln -s /usr/local/cuda/lib64/stubs/libnvcuvid.so /usr/lib/libnvcuvid.so

# decord
git clone --recursive https://github.com/dmlc/decord /home/decord
cd /home/decord

mkdir build && cd build && cmake .. -DUSE_CUDA=/usr/local/cuda -DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc && make && \
cd ../python && python3 setup.py install

yes | pip --no-cache-dir install matplotlib flask
curl -fsSL https://deb.nodesource.com/setup_10.x | bash -
apt-get install -y nodejs

yes | pip --no-cache-dir install opencv-python
yes | pip --no-cache-dir install gdown
apt-get install -y wget

# latest ray
yes | pip --no-cache-dir install pydantic==1.8.1
yes | pip --no-cache-dir install -U https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-2.0.0.dev0-cp38-cp38-manylinux2014_x86_64.whl

cd /mnt/everest


%environment
export NVIDIA_VISIBLE_DEVICES=all
export NVIDIA_DRIVER_CAPABILITIES=video,compute,utility
%runscript
cd /mnt/everest
exec /bin/bash "$@"
%startscript
cd /mnt/everest
exec /bin/bash "$@"
